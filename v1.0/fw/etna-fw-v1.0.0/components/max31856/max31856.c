// ******************************************************************************************************************************************************************
// @file:   
// @brief:  
//
// Created by Dominic Moffat on 11/12/2017.
// Copyright Â© 2017 Illysky. All rights reserved.
// ******************************************************************************************************************************************************************

#include <stdio.h>
#include <string.h>
#include <stdint.h>
#include "max31856.h"


// **************************************************************************************************************************************************************************
//  @func
//  @brief
// **************************************************************************************************************************************************************************
void max31856_init(void) 
{
	
	volatile uint8_t test = 0; 
	test = max31856_read8(MAX31856_CR1_REG);
	
	
	max31856_write8(MAX31856_MASK_REG, 0xFF);
	max31856_write8(MAX31856_CR0_REG, MAX31856_CR0_OCFAULT0);
}

// **************************************************************************************************************************************************************************
//  @func
//  @brief
// **************************************************************************************************************************************************************************
void max31856_set_thermocouple (max31856_thermocoupletype_t type)
{
  uint8_t t =	max31856_read8(MAX31856_CR1_REG);
  t &= 0xF0;
  t |= (uint8_t)type & 0x0F;
  max31856_write8(MAX31856_CR1_REG, t);
}

// **************************************************************************************************************************************************************************
//  @func
//  @brief
// **************************************************************************************************************************************************************************
void max31856_temperature_oneshot (void) 
{
	max31856_write8(MAX31856_CJTO_REG, 0x0);
	uint8_t t = max31856_read8(MAX31856_CR0_REG);
	t &= ~MAX31856_CR0_AUTOCONVERT; // turn off autoconvert!
  t |= MAX31856_CR0_1SHOT;
	max31856_write8(MAX31856_CR0_REG, t);
	max31856_hal_delay (250); 
}

// **************************************************************************************************************************************************************************
//  @func
//  @brief
// **************************************************************************************************************************************************************************
float max31856_read_thc_temperature (void) 
{
	max31856_temperature_oneshot(); 
	
	int32_t temp24 = max31856_read24(MAX31856_LTCBH_REG);
  if (temp24 & 0x800000) {
    temp24 |= 0xFF000000;  // fix sign
  }

  temp24 >>= 5;  // bottom 5 bits are unused

  float tempfloat = temp24;
  tempfloat *= 0.0078125;
  return tempfloat;
}

// **************************************************************************************************************************************************************************
//  @func
//  @brief
// **************************************************************************************************************************************************************************
float max31856_read_cj_temperature (void) 
{
  int16_t temp16 = max31856_read16(MAX31856_CJTH_REG);
  float tempfloat = temp16;
  tempfloat /= 256.0;

  return tempfloat;
}




// **************************************************************************************************************************************************************************
//  @func
//  @brief
// **************************************************************************************************************************************************************************
uint32_t max31856_read8(uint8_t addr) 
{
	uint32_t result = 0;
	uint32_t data = 0;
	addr &= 0x7F; // Ensure read
	uint8_t tx[16]; 
	uint8_t rx[16]; 
	memset (tx, 0, sizeof(tx)); 
	memset (rx, 0, sizeof(rx)); 
	tx[0] = addr; 
	max31856_hal_cs_assert();
	result = max31856_hal_transfer (tx, rx, 2); 
	max31856_hal_cs_deassert();
	data = rx[1]; 
	return data; 
}

// **************************************************************************************************************************************************************************
//  @func
//  @brief
// **************************************************************************************************************************************************************************
uint32_t max31856_read16(uint8_t addr) 
{
	uint32_t result = 0;
	uint32_t data = 0; 
	addr &= 0x7F; // Ensure read
	uint8_t tx[16]; 
	uint8_t rx[16]; 
	memset (tx, 0, sizeof(tx)); 
	memset (rx, 0, sizeof(rx)); 
	tx[0] = addr; 
	max31856_hal_cs_assert();
	result = max31856_hal_transfer (tx, rx, 3); 
	max31856_hal_cs_deassert();
	data = 	((uint16_t) rx[2]) << 0; 
	data |= 	((uint16_t) rx[1]) << 8; 
	return data; 
}

// **************************************************************************************************************************************************************************
//  @func
//  @brief
// **************************************************************************************************************************************************************************
uint32_t max31856_read24(uint8_t addr) 
{
	uint32_t result = 0;
	uint32_t data = 0; 
	addr &= 0x7F; // Ensure read
	uint8_t tx[16]; 
	uint8_t rx[16]; 
	memset (tx, 0, sizeof(tx)); 
	memset (rx, 0, sizeof(rx)); 
	tx[0] = addr; 
	max31856_hal_cs_assert();
	result = max31856_hal_transfer (tx, rx, 4); 
	max31856_hal_cs_deassert();
	data = 	((uint16_t) rx[3]) << 0; 
	data |= 	((uint16_t) rx[2]) << 8; 
	data |= 	((uint16_t) rx[1]) << 16; 
	return data; 
}

// **************************************************************************************************************************************************************************
//  @func
//  @brief
// **************************************************************************************************************************************************************************
uint32_t max31856_write8(uint8_t addr, uint8_t data) 
{
	uint32_t result = 0;
	addr |= 0x80; 				// Ensure write
	uint8_t tx[16]; 
	uint8_t rx[16]; 
	memset (tx, 0, sizeof(tx)); 
	memset (rx, 0, sizeof(rx)); 
	tx[0] = addr; 
	tx[1] = data;
	max31856_hal_cs_assert();
	result = max31856_hal_transfer (tx, rx, 2); 
	max31856_hal_cs_deassert();
	return result; 
}





